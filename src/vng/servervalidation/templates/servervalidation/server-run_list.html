{% extends 'master.html' %}
{% load sniplates %}
{% load index %}


{% block title %}Providers{% endblock %}


{% block content %}
    <article class="article">
        <div class="article__section">
            <h1>Providers</h1>
            <h2>Start een nieuwe provider-test</h2>

            <form class="form" method="post">{% csrf_token %}
                {% load_widgets form='forms.html' %}

                {% for field in form %}
                    {% form_field field %}
                {% endfor %}

                <input type="submit" class="button button--primary" value="Volgende">
            </form>

            {% if object_list %}
                <div class="tabs" data-tab-id="{{second_tab|yesno:"tab-news-items,tab-sub-categories"}}">
                    <nav class="tabs__navigation">
                        <ul class="tabs__list">
                            <li class="tabs__list-item">
                                <h2>
                                    <a class="tabs__link" href="#tab-sub-categories">
                                    Provider test</a>
                                </h2>
                            </li>

                            <li class="tabs__list-item">
                                <h2>
                                    <a class="tabs__link" href="#tab-news-items">
                                    Scheduled test</a>
                                </h2>
                            </li>
                        </ul>
                    </nav>
                    <div class="tabs__track">
                        <div id="tab-sub-categories" class="tabs__tab">
                            <table class="table">
                                {% include 'components/table/header-server-run.html' only %}
                                {% for server_run in object_list.0 %}

                                    {% if not server_run.scheduled %}
                                        {% include 'servervalidation/table/row-server-run.html' with server_run=server_run %}
                                    {% endif %}
                                {% endfor %}
                            </table>
                            {% include 'components/pagination/multiple_pagination.html' with index=0 paginator=paginators|index:0|index:0 page_obj=paginators|index:0|index:1 %}
                        </div>
                        <div id="tab-news-items" class="tabs__tab">
                            <table class="table" >
                                {% include 'components/table/header-server-run-scheduled.html' only %}
                                {% for server_run in object_list.1 %}
                                    {% include 'components/table/row-server-run-scheduled.html' with server_run=server_run %}
                                {% endfor %}
                            </table>
                            {% include 'components/pagination/multiple_pagination.html'  with index=1 paginator=paginators|index:1|index:0 page_obj=paginators|index:1|index:1 params='second_tab=true' %}
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>

    </article>
{% endblock %}


{% block script %}
obj = $("#starting")

function update(){
    $.ajax({
        url:  window.location.origin+"/api/v1/provider-run/" + obj.attr('server_run_id')+'/',
        success: (data, textStatus, jqXHR)=>{
            server_run = data
            console.log(data)
            if (server_run.percentage_exec) {
            obj.html(`${server_run.status_exec}: ${server_run.percentage_exec}%<br /><div style='background-color: green; width: ${ server_run.percentage_exec}%; height: 20px;'></div>`)
            if (server_run.percentage_exec<100)
                setTimeout(() => {
                    update();
                }, 1000);
            if (server_run.percentage_exec == 100) {
                setTimeout(() => {
                location.reload();
                }, 2000);
            }
            }
        }
    })
}

if(obj.length ==1){
    update()
}
{% endblock %}
